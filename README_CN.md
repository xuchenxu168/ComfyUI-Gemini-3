# ComfyUI-Gemini-3-2

功能完整、高性能的 Google Gemini 3 集成插件，为 ComfyUI 提供**所有** Gemini 3 功能。

## 🌟 功能特性

### Gemini 3 核心能力
- ✅ **动态思考级别** (低/高) - 控制推理深度与延迟
- ✅ **媒体分辨率控制** - 精细控制图像/视频/PDF处理
- ✅ **思考签名** - 跨API调用保持推理上下文
- ✅ **函数调用** - 严格验证，支持并行和顺序调用
- ✅ **结构化输出** - JSON schema验证与工具集成
- ✅ **上下文缓存** - 重复内容降低成本（2048+ tokens）
- ✅ **批处理API支持** - 高效处理多个请求

### 多模态支持
- 📝 高级推理文本生成
- 🖼️ 图像理解和生成（每张图最多1120 tokens）
- 🎥 视频分析（每帧70-280 tokens）
- 🎵 音频理解（语音、音乐）
- 📄 PDF文档处理（中等分辨率最优）
- 🔗 URL上下文和网络搜索集成

### 高级功能
- 🧠 **多步骤推理** 保持思考签名
- 🔄 **流式支持** 实时更新
- 🛡️ **安全设置** 可配置[object Object]**Token计数** 和使用追踪
- 🌡️ **温度控制**（为Gemini 3优化）
- 🔧 **系统指令** 自定义行为
- 🔍 **Google搜索** 集成实时信息
- 💻 **代码执行** 数学和数据分析任务

## 📦 安装

1. 克隆到 ComfyUI 的 custom_nodes 目录：
```bash
cd ComfyUI/custom_nodes
git clone https://github.com/yourusername/ComfyUI-Gemini-3-2.git
```

2. 安装依赖：
```bash
cd ComfyUI-Gemini-3-2
pip install -r requirements.txt
```

3. 设置 API 密钥：
   - 从 [Google AI Studio](https://aistudio.google.com/apikey) 获取 API 密钥
   - 设置环境变量：`GEMINI_API_KEY=your_key_here`
   - 或在节点设置中配置

## 🎮 节点说明

### 基础节点

#### 1. Gemini 3 文本生成
使用高级推理能力生成文本。
- **输入**：提示词、图像、音频、视频、PDF、思考级别、媒体分辨率、系统指令
- **输出**：文本、思考签名、使用元数据
- **特性**：多模态输入、可定制思考级别、媒体分辨率控制

### 高级节点

#### 2. Gemini 3 函数调用
执行带严格验证和思考签名保持的函数调用。
- **输入**：提示词、函数声明、思考签名、函数响应
- **输出**：函数调用（JSON）、更新的思考签名、文本响应
- **特性**：并行和顺序函数调用、多步骤推理

#### 3. Gemini 3 结构化输出
生成带schema验证和工具集成的JSON。
- **输入**：提示词、JSON schema、启用Google搜索/代码执行/URL上下文
- **输出**：验证的JSON输出、使用元数据
- **特性**：严格JSON schema验证、与内置工具集成

#### 4. Gemini 3 聊天
自动上下文管理的多轮对话。
- **输入**：消息、聊天历史、系统指令、最大输出tokens
- **输出**：响应、更新的聊天历史（含思考签名）、使用元数据
- **特性**：自动历史管理、思考签名保持

### 流式节点

#### 5. Gemini 3 流式生成
渐进式输出的实时流式生成。
- **输入**：提示词、思考级别、系统指令、最大输出tokens
- **输出**：完整文本、思考签名、流块信息
- **特性**：实时响应流、逐块处理

### 优化节点

#### 6. Gemini 3 创建缓存
创建缓存上下文以优化成本（缓存内容便宜10倍）。
- **输入**：要缓存的内容（最少2048 tokens）、TTL分钟数、缓存名称
- **输出**：缓存名称/引用、缓存信息（含过期时间）、状态
- **特性**：自动TTL管理、使用元数据追踪

#### 7. Gemini 3 使用缓存
使用之前缓存的上下文生成内容。
- **输入**：提示词、缓存名称、思考级别
- **输出**：响应、使用元数据（显示缓存token节省）
- **特性**：显著降低成本、保持完整功能

#### 8. Gemini 3 批处理
以50%折扣高效处理多个请求。
- **输入**：提示词JSON数组、思考级别
- **输出**：批处理名称/ID、状态信息
- **特性**：50%成本降低、24小时处理窗口

### 工具节点

#### 9. Gemini 3 + Google搜索
集成实时网络搜索生成内容。
- **输入**：提示词、思考级别、最大输出tokens
- **输出**：响应、grounding元数据（搜索来源）、使用元数据
- **特性**：实时信息、自动grounding、来源归属

#### 10. Gemini 3 + 代码执行
自动Python代码执行生成内容。
- **输入**：提示词、思考级别
- **输出**：响应、执行结果（代码+输出）、使用元数据
- **特性**：自动代码生成和执行、数学计算

### 安全节点

#### 11. Gemini 3 安全设置
使用可定制安全阈值生成内容。
- **输入**：提示词、思考级别、骚扰/仇恨言论/性暴力/危险内容阈值
- **输出**：响应、安全评级
- **特性**：精细安全控制、详细安全评级、阻止原因报告

## 🚀 使用示例

### 高思考级别的基础文本生成
```
提示词："找出这段多线程C++代码中的竞态条件..."
思考级别：High（高）
→ 详细分析，深度推理
```

### 高分辨率图像分析
```
提示词："读取图片中的所有文字"
图像：[你的图片]
媒体分辨率：High（高，1120 tokens）
→ 准确的OCR和详细分析
```

### 视频理解
```
提示词："描述视频中发生的事情"
视频：[你的视频]
媒体分辨率：Low（低，70 tokens/帧）- 用于一般描述
媒体分辨率：High（高，280 tokens/帧）- 用于文字识别
```

### 带思考签名的函数调用
```
1. 模型调用 check_flight → 返回签名A
2. 发送航班结果 + 签名A
3. 模型调用 book_taxi → 返回签名B
4. 发送出租车结果 + 签名A和B
→ 模型保持推理链
```

## ⚙️ 配置说明

### 思考级别
- **Low（低）**：快速，最小推理 - 用于简单任务
- **High（高）**（默认）：最大推理深度 - 用于复杂任务

### 媒体分辨率
- **图像**：High（1120 tokens）推荐用于大多数任务
- **PDF**：Medium（560 tokens）最适合文档
- **视频**：Low/Medium（70 tokens）用于一般，High（280）用于文字

### 温度
- **默认：1.0** - 为Gemini 3优化
- ⚠️ 改变温度可能导致循环或性能下降

## 📊 性能提示

1. **使用低思考级别** 用于简单任务以减少延迟
2. **使用中等分辨率** 用于PDF（很少从高分辨率受益）
3. **缓存上下文** 2048+ tokens用于重复使用
4. **批量请求** 处理多个项目时
5. **保持温度为1.0** 除非有特定需求

## 🔗 资源链接

- [Gemini 3 开发者指南](https://ai.google.dev/gemini-api/docs/gemini-3)
- [API参考文档](https://ai.google.dev/api)
- [Google AI Studio](https://aistudio.google.com/)
- [定价信息](https://ai.google.dev/pricing)

## 📝 许可证

MIT License - 详见 LICENSE 文件

## 🤝 贡献

欢迎贡献！请先阅读 CONTRIBUTING.md。

## 💬 支持

- 问题反馈：[GitHub Issues](https://github.com/yourusername/ComfyUI-Gemini-3-2/issues)
- 讨论交流：[GitHub Discussions](https://github.com/yourusername/ComfyUI-Gemini-3-2/discussions)

